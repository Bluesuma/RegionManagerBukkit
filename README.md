# RegionManagerBukkit

Плагин для PaperMC/Purpur, который распределяет игроков по регионам для оптимизации TPS (Ticks Per Second) сервера.

## ⚠️ КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ v1.0.1

**Исправлена критическая ошибка**, которая вызывала зависание сервера на 40+ секунд при загрузке чанков. Теперь загрузка чанков происходит асинхронно и не блокирует главный поток сервера.

### Что было исправлено:
- ✅ **Асинхронная загрузка чанков** - предотвращает блокировку сервера
- ✅ **Ограничение радиуса загрузки** - максимум 4 чанка по умолчанию
- ✅ **Пакетная загрузка** - максимум 16 чанков за раз
- ✅ **Настраиваемые задержки** - контроль скорости загрузки
- ✅ **Улучшенное логирование** - отслеживание процесса загрузки

## Описание

RegionManagerBukkit автоматически управляет распределением игроков по регионам, чтобы поддерживать стабильный TPS 20. Регион - это область мира, содержащая игроков и управляющая загрузкой чанков. Плагин автоматически выгружает регионы без игроков для экономии RAM и улучшения производительности.

## Основные возможности

- **Автоматическое распределение игроков** по регионам
- **Оптимизация TPS** - поддержание стабильных 20 TPS
- **Умная загрузка чанков** - загрузка только необходимых чанков
- **Асинхронная загрузка** - не блокирует главный поток сервера
- **Автоматическая выгрузка** пустых регионов
- **Мониторинг производительности** в реальном времени
- **Команды администратора** для управления плагином
- **Гибкая конфигурация** через config.yml

## Требования

- **Java 17** или выше
- **PaperMC 1.20.4** или **Purpur 1.20.4**
- **Maven 3.6+** (для сборки из исходников)

## Установка

### 1. Скачивание готового JAR

1. Скачайте `RegionManagerBukkit-1.0.0.jar` из раздела [Releases](https://github.com/your-repo/RegionManagerBukkit/releases)
2. Поместите файл в папку `plugins/` вашего сервера
3. Перезапустите сервер

### 2. Сборка из исходников

```bash
# Клонирование репозитория
git clone https://github.com/your-repo/RegionManagerBukkit.git
cd RegionManagerBukkit

# Сборка проекта
mvn clean package -DskipTests

# Копирование JAR файла
cp target/RegionManagerBukkit-1.0.0.jar /path/to/your/server/plugins/
```

## Конфигурация

После первого запуска сервера будет создан файл `plugins/RegionManagerBukkit/config.yml`:

```yaml
# Настройки регионов
regions:
  # Размер региона в блоках (должен быть кратен 16)
  size: 512
  # Максимальное количество игроков в одном регионе
  max-players-per-region: 20
  # Минимальное расстояние между центрами регионов
  min-distance-between-regions: 256
  # Автоматическое выгрузка пустых регионов (в секундах)
  auto-unload-delay: 300

# Настройки загрузки чанков (НОВОЕ!)
chunk-loading:
  # Максимальный радиус загрузки чанков вокруг игрока (в чанках)
  max-view-distance: 4
  # Задержка между загрузкой чанков (в миллисекундах)
  chunk-load-delay: 10
  # Асинхронная загрузка чанков (РЕКОМЕНДУЕТСЯ: true)
  async-chunk-loading: true
  # Максимальное количество чанков для загрузки за раз
  max-chunks-per-batch: 16

# Настройки производительности
performance:
  # Интервал проверки TPS (в тиках)
  tps-check-interval: 100
  # Целевой TPS для оптимизации
  target-tps: 20.0
  # Минимальный TPS для принудительной оптимизации
  min-tps: 15.0
  # Максимальное количество активных регионов
  max-active-regions: 50
  # Принудительная выгрузка регионов при низком TPS
  force-unload-on-low-tps: true

# Настройки логирования
logging:
  # Логирование операций с регионами
  region-operations: true
  # Логирование производительности
  performance-metrics: true
  # Логирование перемещений игроков
  player-movements: false
  # Логирование загрузки чанков (НОВОЕ!)
  chunk-loading: false
  # Уровень детализации логов (DEBUG, INFO, WARN, ERROR)
  level: INFO

# Настройки отладки
debug:
  # Показывать границы регионов
  show-region-borders: false
  # Показывать информацию о регионах в чате
  show-region-info: false
  # Тестовый режим (не применяет изменения)
  test-mode: false
```

### Рекомендуемые настройки загрузки чанков

```yaml
chunk-loading:
  # Для слабых серверов
  max-view-distance: 2
  chunk-load-delay: 20
  async-chunk-loading: true
  max-chunks-per-batch: 8
  
  # Для средних серверов
  max-view-distance: 4
  chunk-load-delay: 10
  async-chunk-loading: true
  max-chunks-per-batch: 16
  
  # Для мощных серверов
  max-view-distance: 6
  chunk-load-delay: 5
  async-chunk-loading: true
  max-chunks-per-batch: 24
```

## Команды

### Основные команды

- `/region info` - Информация о плагине и текущем TPS
- `/region stats` - Статистика регионов
- `/region list` - Список активных регионов
- `/region player <игрок>` - Информация о регионе игрока
- `/region optimize` - Принудительная оптимизация регионов
- `/region reload` - Перезагрузка конфигурации
- `/region debug` - Переключение отладочного режима

### Права доступа

- `regionmanager.admin` - Доступ к административным командам (по умолчанию: op)
- `regionmanager.info` - Просмотр информации о регионах (по умолчанию: true)

## Как это работает

### Принцип работы регионов

1. **Создание регионов**: Когда игрок присоединяется к серверу, плагин создает или находит подходящий регион
2. **Распределение игроков**: Игроки автоматически распределяются по регионам с учетом расстояния и загрузки
3. **Управление чанками**: Плагин загружает только чанки, необходимые для игроков в регионе
4. **Асинхронная загрузка**: Чанки загружаются в фоновом режиме без блокировки сервера
5. **Оптимизация**: При падении TPS плагин автоматически оптимизирует регионы

### Алгоритм оптимизации

- **Мониторинг TPS**: Постоянное отслеживание производительности сервера
- **Экстренная оптимизация**: При критически низком TPS (< 15) принудительная выгрузка пустых регионов
- **Регулярная оптимизация**: Объединение близких регионов и выгрузка неиспользуемых чанков
- **Очистка памяти**: Автоматическая очистка неактивных регионов

## Производительность

### Рекомендуемые настройки

- **Размер региона**: 512 блоков (оптимально для большинства серверов)
- **Максимум игроков в регионе**: 20 (зависит от производительности сервера)
- **Максимум активных регионов**: 50 (настройте под ваше железо)
- **Радиус загрузки чанков**: 2-4 чанка (зависит от производительности)

### Мониторинг

Плагин предоставляет подробную статистику:
- Текущий TPS
- Количество активных регионов
- Количество игроков в регионах
- Время работы регионов
- Статистика загрузки чанков

## Устранение проблем

### Частые проблемы

1. **Низкий TPS**
   - Уменьшите `max-players-per-region`
   - Уменьшите `max-active-regions`
   - Уменьшите `max-view-distance`
   - Включите `force-unload-on-low-tps`

2. **Высокое потребление RAM**
   - Уменьшите `auto-unload-delay`
   - Уменьшите `max-chunks-per-batch`
   - Включите `performance-metrics` для мониторинга

3. **Зависание сервера при загрузке чанков**
   - Убедитесь, что `async-chunk-loading: true`
   - Уменьшите `max-view-distance`
   - Увеличьте `chunk-load-delay`
   - Уменьшите `max-chunks-per-batch`

4. **Плагин не загружается**
   - Проверьте версию Java (требуется Java 17+)
   - Проверьте совместимость с версией сервера

### Логи

Включите отладочный режим для получения подробной информации:
```yaml
logging:
  level: DEBUG
  region-operations: true
  performance-metrics: true
  chunk-loading: true  # Для отслеживания загрузки чанков
```

## Разработка

### Структура проекта

```
src/
├── main/
│   ├── java/com/regionmanager/
│   │   ├── RegionManagerPlugin.java      # Главный класс плагина
│   │   ├── region/
│   │   │   └── Region.java              # Класс региона
│   │   ├── managers/
│   │   │   ├── RegionManager.java       # Менеджер регионов
│   │   │   └── PerformanceManager.java  # Менеджер производительности
│   │   ├── listeners/
│   │   │   └── PlayerListener.java      # Обработчики событий игроков
│   │   ├── commands/
│   │   │   └── RegionCommand.java       # Команды плагина
│   │   └── utils/
│   │       └── Logger.java              # Утилита логирования
│   └── resources/
│       ├── plugin.yml                   # Метаданные плагина
│       └── config.yml                   # Конфигурация по умолчанию
└── test/
    └── java/com/regionmanager/
        └── RegionManagerTest.java       # Тесты
```

### Сборка для разработки

```bash
# Установка в локальный репозиторий
mvn clean install

# Сборка с отладочной информацией
mvn clean package -Dmaven.compiler.debug=true

# Запуск тестов
mvn test
```

## Лицензия

Этот проект распространяется под лицензией MIT. См. файл [LICENSE](LICENSE) для подробностей.

## Поддержка

- **Issues**: [GitHub Issues](https://github.com/your-repo/RegionManagerBukkit/issues)
- **Discussions**: [GitHub Discussions](https://github.com/your-repo/RegionManagerBukkit/discussions)
- **Wiki**: [GitHub Wiki](https://github.com/your-repo/RegionManagerBukkit/wiki)

## Вклад в проект

Мы приветствуем вклад в развитие проекта! Пожалуйста, ознакомьтесь с [CONTRIBUTING.md](CONTRIBUTING.md) для получения информации о том, как внести свой вклад.

## Благодарности

- **PaperMC Team** - за отличную платформу для разработки плагинов
- **Spigot Community** - за документацию и примеры кода
- **Bukkit Team** - за API для разработки плагинов

---

**Версия**: 1.0.1 (с критическим исправлением)  
**Автор**: RegionManager  
**Последнее обновление**: 2024 